I’m sending a long context. Do not reply until I write: READY. Just acknowledge received.

# DG Do — Canonical Domain Laws (v0.2, Production-Oriented)

> **Scope**
> These laws define **non-negotiable invariants** of the DG Do platform.
> Any violation is a **production-blocking defect**.
> Experimental behavior is allowed **only outside production**.

---

## 0. System Design Principles (Global)

These principles apply to **every service, API, and data model**.

### 0.1 Architectural Principles

* **Single Responsibility (SRP):** each service owns exactly one domain concern.
* **Explicit Contracts:** `.proto` files are the only source of truth.
* **Loose Coupling:** services interact only via versioned APIs/events.
* **High Cohesion:** domain logic never leaks across service boundaries.

**Primary KPI**

* **Mean Time to Change (MTTC)** per service (hours)
* **Defect Containment Ratio**
  `% of incidents isolated to one service`

### 0.2 Operational Principles

* **All operations are idempotent.**
* **All state transitions are explicit and auditable.**
* **All services are containerized and stateless** (except storage).
* **Failure is expected; undefined behavior is forbidden.**

**Primary KPI**

* **Successful Retry Rate** (% retries resolved without manual intervention)
* **Recovery Time Objective (RTO)**

---

## 1. TripRequest Domain Laws

### 1.1 Purpose

`TripRequest` represents **passenger intent**, not a financial or operational commitment.

**Primary KPI**

* **Request-to-Trip Conversion Rate**

  ```
  completed_trips / created_trip_requests
  ```

### 1.2 Invariants

1. A `TripRequest` **may exist without a driver**.
2. A passenger may have **at most one ACTIVE TripRequest**.
3. Origin and destination **must be valid geo-locations**.
4. Requests outside serviceable regions **must fail fast** with explicit error codes.
5. Cancellation is allowed **until a Trip is created**.

**Primary KPI**

* **Invalid Request Rejection Latency (ms)**
* **Duplicate Request Suppression Rate**

### 1.3 Idempotency

* Idempotency key:

  ```
  trip_request:{passenger_id}
  ```
* Repeated creation attempts:

  * return existing active request, or
  * deterministically cancel + recreate (policy-driven).

**Primary KPI**

* **Duplicate API Call Collapse Rate**

  * `% of retries resolved idempotently`

### 1.4 Cold-Start Handling

* If no drivers are available:

  * TripRequest is **persisted and queued**
  * Passenger receives ETA or fallback options
* No synchronous retries or busy-waiting.

**Primary KPI**

* **Cold-Start Fulfillment Rate**

  ```
  trips_started_after_queue / queued_requests
  ```

---

## 2. Trip Domain Laws (FSM-Enforced)

### 2.1 Purpose

`Trip` is a **binding operational contract** involving:

* passenger
* driver
* time
* money
* liability

**Primary KPI**

* **Completed Trips per Active Driver per Hour**
* **Gross Revenue per Trip**

### 2.2 Creation Rules

1. A `Trip` **MUST have a driver at creation**.
2. A `Trip` **MUST reference a valid TripRequest**.
3. `Trip` creation is **idempotent by TripRequest ID**.
4. Immutable fields:

   * passenger_id
   * driver_id
   * origin
   * destination
   * creation timestamp (UTC)

**Primary KPI**

* **Trip Creation Success Rate**
* **Time from Request → Trip Creation (ms)**

### 2.3 Trip Lifecycle (FSM — mandatory)

`Trip` **MUST** be implemented as a **Finite State Machine** inside `TripService`.

Allowed transitions only:

```
ACCEPTED → EN_ROUTE → COMPLETED
ACCEPTED → CANCELLED
EN_ROUTE → CANCELLED_BY_DRIVER
```

Any other transition:

* is rejected
* logged
* counted as a protocol violation

**Primary KPI**

* **FSM Compliance Rate**

  ```
  valid_transitions / total_transitions
  ```

### 2.4 Failure Handling

* Driver drop-off:

  * transition → `CANCELLED_BY_DRIVER`
  * passenger notified
  * optional auto-reassignment (policy-controlled)
* All timestamps are immutable and UTC.

**Primary KPI**

* **Driver Drop-Off Recovery Rate**

  * trips successfully reassigned or gracefully cancelled

---

## 3. MatchingService Laws (Pure, Deterministic)

### 3.1 Responsibility

MatchingService is a **pure decision engine**.

It:

* computes candidate drivers
* assigns probabilities
* never mutates system state

**Primary KPI**

* **Matching Latency (p95)**
* **Cost per Match (CPU ms)**

### 3.2 Determinism

For identical inputs + seed:

* identical candidates
* identical probabilities
* identical ordering

**Primary KPI**

* **Replay Accuracy Rate**

  * `% of matches reproducible from logs`

### 3.3 Constraints

1. Only **available drivers** may be returned.
2. Candidate set size is bounded (`max_candidates`).
3. Probability distribution:

   * sum = 1 ± ε
   * immutable once computed

**Primary KPI**

* **Match Acceptance Rate**

  * accepted_matches / offered_matches

### 3.4 Failure Behavior

* Empty candidate set → explicit reason code.
* Crashes or timeouts → safe retry with same input and seed.

**Primary KPI**

* **Graceful Degradation Rate**

  * failures handled without cascading errors

---

## 4. API Gateway / Orchestration Laws

### 4.1 Responsibilities

API Gateway:

* orchestrates calls
* performs sampling
* enforces idempotency
* logs decisions

**Primary KPI**

* **End-to-End Request Success Rate**
* **Gateway Latency Overhead**

### 4.2 Sampling

* Sampling occurs **only here**
* Uses **seed-based deterministic sampling**
* Probabilities are never modified

**Primary KPI**

* **Sampling Fairness Index**

  * variance in driver exposure over time

### 4.3 Reliability

* Retry-safe by design
* No direct Trip mutation
* Failed Trip creation:

  * retried idempotently, or
  * queued for async recovery

**Primary KPI**

* **Successful Orchestrated Retry Rate**

---

## 5. Driver & Passenger Laws

1. A driver may participate in **only one active Trip**.
2. Only drivers marked **AVAILABLE** may be matched.
3. Driver connectivity loss:

   * driver marked unavailable
   * in-progress trips handled by TripService FSM
4. Passenger state is **derived**, not inferred.

**Primary KPI**

* **Driver Utilization Rate**
* **Idle Driver Time (minutes/hour)**

---

## 6. Eventing & Telemetry Laws

### 6.1 Event Model

* Events are **append-only**
* Events are **fail-safe**
* Event duplication is allowed; side effects are idempotent

**Primary KPI**

* **Event Delivery Reliability**
* **Event Lag (p95)**

### 6.2 Mandatory Telemetry

Logged for every critical operation:

* TripRequest lifecycle
* Matching results
* Sampling decisions
* Trip FSM transitions
* Failures, retries, cancellations

**Primary KPI**

* **Incident Diagnosis Time**

  * time from alert → root cause

### 6.3 Replayability

* Any incident must be reproducible via event replay.
* Sampling seeds are persisted.

**Primary KPI**

* **Replay Coverage Rate**

  * % of incidents reproducible offline

---

## 7. Probabilistic & ML Laws

1. Matching outputs are immutable training data.
2. All selections are replayable via seed.
3. Cold-start statistics are explicitly tracked.
4. Data drift is monitored continuously.
5. Retraining is triggered by **metric degradation**, not intuition.

**Primary KPI**

* **Model Lift vs Baseline**
* **Revenue per Kilometer**

---

## 8. High Availability & Risk Management Laws

### 8.1 Availability

* No single point of failure.
* Stateless services + replicated storage.
* Leader election and failover supported.

**Primary KPI**

* **Service Uptime (SLA %)**
* **Failed Match Rate under Load**

### 8.2 Data Safety

* Databases must support:

  * replication
  * backups
  * transactional guarantees
* Idempotency enforced at storage level (unique constraints).

**Primary KPI**

* **Recovery Point Objective (RPO)**
* **Backup Restore Success Rate**

### 8.3 Performance & SLAs

* Latency budgets defined per service.
* MatchingService must degrade gracefully under load.
* Slowdowns are observable before outages.

**Primary KPI**

* **Latency Budget Compliance Rate**

---

## 9. Deployment & Governance

1. Generated code is **never edited manually**.
2. Invariants are enforced by:

   * unit tests
   * integration tests
   * replay tests
3. Failed tests = **deployment blocked**.
4. Versioned APIs only; breaking changes require migration plans.

**Primary KPI**

* **Failed Deployment Prevention Rate**

  * % of issues caught pre-production
